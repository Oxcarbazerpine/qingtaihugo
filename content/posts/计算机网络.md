---
title: "计算机网络"
date: 2024-06-01
draft: false
tags: ["Network"]
---

-王道考研
第一章 计算机网络体系结构
可以互相通信，但没有互相控制
组成部分：硬件，软件，协议
工作方式：边缘部分：用户直接使用
                核心部分：为边缘提供支持
功能：数据通信，资源共享

分类
       分布范围：广域网WAN，城域网MAN，局域网LAN，个人区域网PAN
       使用者：公用网，专用网
       交换技术：电路交换，报文交换，分组交换
       传输技术：广播式，点对点式

-思科Cisco Packet Tracer仿真实验
TCP/IP 四层协议体系
数据链路层：数据的物理传输以及网卡驱动读取数据
网络层：控制数据包的路由和转发
传输层：控制计算机之间端到端的通信
应用层：各种应用程序的逻辑

集线器:一种总线网络，无差别广播以及发生碰撞
概念：IP地址， MAC地址
ARP协议：Address Resolution Protocol
属于网络层。维护一个ARP表，记录ip地址，MAC号，网络接口。其它协议不知道发送目的的MAC号时，首先发送ARP包广播询问MAC号，并更新表项，再次尝试发送原包。

---

**自顶而下**
# Intro
宽带接入：
* 复用电话线路：数字用户线DSL(Digital Subscriber Line)
* 复用有线电视线路：光纤+同轴电缆
* FTTH光纤入户：将光纤线拉到家里
* 卫星链路接入
* WiFi:无线LAN接入-调制解调器-ISP
* 广域无线接入：3G


物理媒介
* 双绞铜线：两根绞合的铜线，电话线，10M~10G，高速LAN网
* 同轴电缆：两个同心铜导体，数十MB
* 光纤：数百GB，不受电磁干扰，长途不衰减。成本高
* 无线电信道
* 卫星无线电：280ms时延，数百M



分组交换
路由器的存储转发：
* 缓存完整分组后转发，延迟为2L/R
* 排队时延queue delay：路由器的缓存有限，造成丢包packet lost
* 转发表forwarding table：端口ip与物理编号


电路交换：预定资源，电路交换机构成
收发方先建立一条能直接联通的电路circuit，确保能以恒定速率传输数据。
每个电路交换机预留恒定带宽维持通信
* 频分复用FDM|Frequency-Division Multiplexing:分配固定的频段，收音机FM也是
* 时分复用TDM：在循环的TDM帧重每条电路被分配专用时隙


互联网：网络的网络，
1. 第一层ISP-十数个
2. 区域ISP-数十万个
3. 接入ISP


延迟：1. 处理时延 2. 排队时延 3. 传输时延（推到线路上所用时间） 4. 传播时延
流量强度/传输速率，接近1时，排队时延无限长
丢包：超出缓冲区，被路由器丢弃
吞吐量：单位时间传送的比特量，由链路的瓶颈决定

五层协议：
1. 应用层：HTTP, SMTP, FTP
2. 传输层：TCP, UDP
3. 网络层：IP
4. 链路层：帧
5. 物理层


网络攻击：DDoS Distributed denial of service
从多出大量发送请求流量占据服务器资源
SSL:Secure Sockets Layer 应用层实现的TCP的加密增强，调用SSL库的API

协议：可靠传输，吞吐量，定时，安全性

# 应用层
* HTTP
	* 持续链接与非持续连接
		* HTTP默认持续连接
		* 往返时间RTT Round-Trip Time: TCP连接需要两个RTT+文件传输时间
	* TCP连接的串行和并行
	* 请求报文
		* 请求行：GET(方法字段) /path/to/index.html(URL字段) HTTP/1.1(HTTP版本字段)
		* 首部行：Host, Connection: close, User-agent, Accept-language
		* 实体主体：POST方法荷载
	* 响应报文：结构和请求一样
		* 状态码
			* 301 Moved Permanently 永久转移了，新URL在首部的Location行中
			* 400 Bad Request 服务器无法理解请求
			* 505 HTTP Version Not Supported
		* 服务端发回带有set-cookie字段的首部，下次客户端发送请求时把cookie加入首部
		* Web缓存服务器/用户代理：与高速缓存很像，收到请求后查看有无本地缓存，没有则自己发一份请求取回缓存，再返回原来的请求。
			* 如何保证不过时（条件GET）：代理服务器接受到请求后，向原始服务器发送一条询问请求，首部添加 If-Modified-Since: 上次缓存的获得时间。若未被更改，原始服务器回复状态304 Not Modified
* FTP

	* 两个并行TCP连接
		* 控制连接control connection 端口21（控制信息带外out-of-band传送，HTTP是带内传送），会话期间持续
		* 数据连接data connection 端口20，每次文件传输新建
	* 请求命令：
		* USER username: 账号
		* PASS password: 密码
		* LIST：通过新建数据连接传送文件列表
		* RETR filename: 取回文件
		* STOR filename: 上传文件
	* 响应：
		* 331 Username OK, Password required
		* 125 Data connection already open; transfer starting.
		* 425 Can't open data connection
		* 452 Error writing file
* SMTP：TCP base，持续连接，仅有PUSH操作
	* 用户代理（客户端），SMTP，发送方服务器（端口25），SMTP，接收方服务器，{POP3,IMAP,HTTP}，接收方用户代理
	* 过程：用户代理发送到发送方服务器，发送方服务器维护一个报文队列，定时尝试发送到接收方服务器，接收者从接收方服务器取回到本地用户代理
		* Client: HELO（打招呼）, MAIL FROM: <abc@xyz.com>, RCPT TO, DATA, QUIT
		* Server: 状态码和英文解释
	* 特点：
		* 限制7位ASCII编码，多媒体数据只能先编码，收件后再解码
		* 直接在收发服务器之间建立TCP连接，无论其有多远，不通过中间邮件服务器
	* 手动对话练习
		* telnet smtp.163.com 25
		* HELO 163.com
		* mail from: xxx@163.com; rcpt to: xxx@163.com; data; CRLF.CRLF


* 拉取邮件

	* POP3：Post Office Protocol-Version3 端口110
		* 三阶段：
			* 验证authorization：user <username>, pass <password>
			* 事务处理，list, retr <list No.>(取回第几条), dele <list No.>（将第几条打上删除标记）
			* 更新，客户发送quit后，删除带有标记的条目
		* 服务端响应： +OK， -ERR
		* 实验：

			* telnet pop.qq.com 110
			* user fengtrss@qq.com
			* pass bwmslztgvjdrdjjj(生成的授权码)
			* list, retr 1, dele 1, retr 2, quit
	* IMAP: Internet Mail Access Protocol：支持在服务器上分配文件夹，查询匹配邮件
	* HTTP
* DNS：Domain Name System 端口53，UDP base
	* DNS服务器实现的分布式数据库+查询分布式数据的应用层协议
	* 使用范围：HTTP，SMTP，FTP
	* 功能：
		* 获取主机别名（www.baidu.com）和规范canonical主机名（relay1.east.baidu.com）的对应关系；
		* 负载分配：一个域名对应多个IP地址，可能按次序循环分配IP
	* 分布式数据库
		* root(返回顶级域TLD:Top-Level Domain IP地址），13个根服务器域名
			* com DNS （顶级域服务器：返回权威服务器IP地址）
				* yahoo.com
				* amazon.com （权威服务器：返回www.amazon.com IP地址）
			* org DNS
				* pbs.org
			* edu DNS
				* poly.edu
				* ucla.edu
	* 本地DNS服务器：通过DHCP获取局域网主机的IP，作为代理，转发DNS请求到根DNS服务器
	* 过程：浏览器调用本机运行的DNS client，向本地DNS发送域名请求，本地DNS查得后返回结果
		* 递归查询：层层代理，层层返回
			* 本地DNS(www.baidu.com)->root(com)->TLD(baidu.com)->权威DNS(www)
		* 迭代查询：所有请求由本地DNS发出
			* 本地DNS(www.baidu.com)->root(com)->本地DNS
			* 本地DNS(baidu.com)->TLD(baidu.com)->本地DNS
			* 本地DNS(www.baidu.com)->权威DNS(www.baidu.com)->本地DNS
	* DNS缓存：本地DNS缓存各级域名IP对应表，直接返回结果
	* DNS记录和报文(Name, Value, Type, TTL)
		* TTL生存时间
		* A: (relay1.bar.foo.com~主机名，145.37.13.2~IP地址，A)
		* NS:(foo.com~域名，dns.foo.com~权威DNS主机名，NS)
		* CNAME:(foo.com~域名，relay1.bar.foo.com~规范C主机名NAME，CNAME)
		* MX:(foo.com~域名，mail.bar.com邮件服务器主机名，MX)



P2P-peer to peer
* 文件分发
	* 随着分发数量增多，P2P分发时间不会线性增长，而是接近某一界限
	* BitTorrent（TCP base）
		* 所有对等方集合称为一个torrent洪流
		* 有一个追踪器tracer掌握所有洪流地址
		* 当一个新人A加入时
            1. 向追踪器注册自己，并周期性的维持
            2. 追踪器在A注册时随机选择一些对等方的列表发给A
            3. A尝试同列表的所有人建立并行TCP连接，询问他们具有的块列表
            4. A找出当中出现最少的块进行请求，稀缺优先rarest first。可以使得块均匀分布
            5. A同时也收到许多请求，A选择能以最高速率传输数据给A自己的4个人（称为疏通unchocked），给出优先权
            6. 每隔30秒，A随机选择列表中另外的人发送一些试探的块，如果对方B接受的速率很大，A会被B列为unchoked，B会发送块给A，如果A接收速度很高，B也成为A的unchoked。这样可以不断选择更好的伴侣
* 分布式数据库的实现，DHT
	* DHT-Distributed Hash Table：分布式散列表，一张哈希表的不同部分储存在不同的对等方上
	* 键是要请求的资源名的哈希值，值是对等方IP地址
	* 环形DHT：每个对等方知道自己的直接后继和直接前任，查询者向任意对等方发送键值，收到的对等方检查是否是自己负责的键值，如果是就响应查询者；如果不是，向后继或者前任发送查询，直到找到对应键值的对等方。
		* 最坏复杂度O（N/2）
		* 为了减少查询次数，除了直接后继和前任，每个对等方还可以再储存若干条指向别的对等方的*捷径*
	* 对等方扰动：为了应对对等方突然加入和离开系统，每个对等方除了前任和第一后继，还要知道第二后继，并周期性地向两个后继发送ping测试。假设3，4，5，7四个相邻对等方
		* 如果5突然离开：
			* 4收不到5的响应，4把其第二后继7设为第一后继，发报询问7的第一后继是谁（假设是10），并把10设为自己的第二后继
			* 3收不到5的响应，3发报给4询问4的第二后继是谁（7），并把7设为自己的第二后继
		* 如果6突然加入：
			* 假设6只知道1，向1发报询问自己的前任和后继是谁，通过1和后续的转发，报文来到5，5确定自己是6的直接前任，向6发送自己的IP作为其前任，自己的两个后继IP作为其后继。6收到5的回答后设置好前任和后继，发报通知5把直接后继改为6



# 传输层
* 将ip的主机之间交付扩展到进程间交付，称为运输层的；以套接字为出入口
	* 多路复用：multiplexing
	* 多路分解：demultiplexing
	* 无连接的UDP
		* 传输层报文头部的端口号：16bit，0~1023是周知端口号（see RFC 1700）
			* 16bit源端口号+16bit目的端口号
			* 传输过程：报文到达主机-传输层检查目的端口号-定向到响应套接字-数据通过套接字到响应进程
	* 面向连接的TCP
		* 用四元组来决定套接字（源IP，源端口号，目的IP，目的端口号）
* UDP
	* 只做了最少的必要工作，复用分解（附加上源和目的端口）+差错检测+网络层的IP
* 可靠通信协议
	* FSM发送方式
		* 发送方停等（stop-and-wait）:只有收到接收方的ACK或NAK回复才能改变状态发送新的分组
		* 流水线
	* 对失败分组的处理
		* 回退N步Go-Back-N
			* 另称滑动窗口协议
			* 发送方：窗口长度N，base（第一个已发送而未被确认的），nextseqnum（马上要发送的）
			* 接收方只需要维护下一个分组的序号，只接受正确的下一个分组，其他情况丢弃分组，并返回上一个已确认分组的ACK
			* 从未收到的包开始重传，一直到窗口上限
		* 选择重传Selective Repeat
			* 只重传未收到确认的包
			* 发送方对收到的ACK序号依次确认
	* 确保可靠的方式
		* 检验和：检验包内的比特错误
		* 序号：保证可以检测出冗余的副本
		* 定时器：接收ACK是否超时，重传
		* 确认
		* 否定确认
		* 窗口：可以缓存乱序的分组，保证可以连续发送
* TCP
	* 三次握手
		* 为了双方各自确认对方能发能收
		* 前两次空载，第三次可以载包
	* 组成：缓存，变量，与进程连接的套接字；（中间的路由器不做任何事）
	* MSS(Maximum Segment Size)最大报文段长度：指的是应用层数据的最大长度
	* 报文段结构：
		* 源端口16，目的端口16
		* 序号32（字节流的序号），确认号32
		* 首部长度，保留未用，URG紧急,ACK,PSH应立即上交数据,RST,SYN,FIN,接收窗口
		* 因特网检验和，紧急数据指针
		* 选项，数据
	* 累积确认cumulative acknowledgment：一直在确认字段发送自己想要的下一个序号
	* 超时重传
		* 估计定时器时间：加权平均值：EstimatedRTT=0.875EstimatedRTT + 0.125*SampleRTT
		* TimeoutInterval = EstimatedRTT + 4*DevRTT
		* 超时后Interval加倍，简单的拥塞控制
	* 快速重传：应对超时重传的延迟过大
		* 接收方收到非期望的别的包时，重新发送自己期待的ACK，即产生一个冗余ACK
		* 发送方收到3次冗余ACK后立即重传
	* 流量控制 flow-control
		* 目的：为了匹配接收方的读取速率而抑制发送方发送速率
		* 接收窗口 receive window
			* 对主机B来说  rwnd = RcvBuffer - [ LastByteRcvd - LastByteRead ] 随着每次的确认报文发送rwnd
			* 对主机A来说 要保证 LastByteSent - LastByteAcked <= rwnd
	* 连接建立 three-way handshake
		* client发送SYN报文段：首部SYN bit为1，随机选择初始序号client_isn，无应用数据 【CLOSED → SYN_SENT】
		* server发送SYNACK报文段：SYN为1，确认号为client_isn+1, 随机选的初始序号server_isn；服务器分配缓存和变量 【（CLOSED → ）LISTEN → SYN_RCVD】
		* client发送确认：SYN为0（之后都0），seq=client_isn+1, ack=sever_isn+1；客户端分配缓存和变量 【SYN_SENT → ESTABLISHED】 server[SYN_RCVD →ESTABLISHED]
	* 连接关闭  (客户端发起)
		* client: FIN 【ESTABLISHED → FIN_WAIT_1】
		* server: ACK  【ESTABLISHED → CLOSN_WAIT】client[FIN_WAIT_1 → FIN_WAIT_2]
		* server: FIN 【CLOSN_WAIT → LAST_ACK】
		* client: ACK , setTimeout(30s) -> close  【FIN_WAIT_2 → CLOSED】
	* SYN洪范攻击 flood attack
		* 攻击者大量发送SYN报文段，但不第三次握手，白白让服务器分配资源
		* SYN cookie防御方法：收到SYN后不分配资源，用报文的源和目的IP以及一个秘密数计算一个哈希值cookie，把cookie作为server_isn发送。（相当于塞了一些信息给发送者）
		* 如果发送者正常，会回复ACK，server再计算一遍cookie并+1，看值是否等于ACK的值（发送方会将值加1），如果相等server再生成全开连接
	* RST标志：server收到的报文段端口与自己的监听端口不匹配，则返回RST=1的重置报文段
	* 一般拥塞控制
		* 链路最大速率导致的无限时延
		* 分组重传占用带宽增加时延，减速
		* 分组最终被丢弃时，前序路由器的速率被浪费了
		* 手段
			* 端到端
			* 路由器提示，通过反馈专门的包或者改变接收发发回的包的字段
	* TCP拥塞控制
		* 采用端到端控制
		* 丢包事件：超时或收到3个冗余ACK
		* 维护cwnd(congestion window) 窗口取cwnd和rwnd的小者；窗口越大发送速率越大
		* 带宽检测：逐步增加窗口大小，直到拥塞事件
		* TCP分叉：避免慢启动时延过大，采用CDN，主机和CDN开启常规慢启动tcp，CDN和远程中心服务器开启一个窗口极大的TCP连接，大幅减小了客户和远端服务器的时延
		* 具体算法
			* 慢启动
				* ssthresh(slow start threshold)：cwnd增长的阈值
				* cwnd从1wnd开始，每收到一个ACK cwnd+1，相当于每个RTT cwnd*2，窗口大小指数增长
				* 持续时长很短，统计中经常忽略
			* 拥塞避免
				* cwnd超过阈值ssthresh时，cwnd每一轮只增加一个MSS，呈线性增加，具体做法是每收到一个ACK，cwnd = cwnd + MSS*(MSS/cwnd)
				* 状态的终止：丢包事件发生时终止，进入快速恢复状态
					* 超时时：cwnd归为1MSS，ssthresh = 1/2 cwnd
					* 3个冗余ACK时：newCwnd = 1/2 cwnd，ssthresh = 1/2 cwnd
			* 快速恢复
				* 再次开始cwnd指数增加策略
				* 如果又发生了丢包事件，newCwnd = 1MSS，ssthred = 1/2 cwnd，状态进入慢启动
		* TCP拥塞算法特征：
			* 锯齿形速率曲线，AIMD（Additive-Increase, Multiplicative-Decrease）加性增，乘性减
			* 平均吞吐量：0.75* (cwndMax/RTT)
			* 多条TCP链路最终收敛到公平享用可用带宽
			* UDP可能会不断压缩TCP的带宽
			* 应用使用多条并行TCP连接就会多占带宽



# 网络层
路由器的功能
* 转发forwarding：把进来的分组从某个出口送出去
* 路由routing：选择路线，从哪个出口转发出去
* IP协议: 一种尽力而为best-effort的协议
* 创建连接与否
	* 有连接-虚电路网络Virtual-Circuit VC
		* 在路途的每一跳选择一个VC号，路由器维持一个VC号转换表，动态增删表项，来决定下一跳要使用的VC号
			* 连接建立成本低，不用相互协商相同的VC号
			* 输入接口--输入VC号--输出接口--输出VC号
			* VC号可以很短就能保持每一跳的唯一性
		* 虚电路建立
		* 数据传送
		* 虚电路拆除：发送方通知路途中的路由器更新表项，另一侧的端系统结束呼叫
	* 无连接-数据报网络Datagram network
		* IP地址最长前缀匹配，一个前缀对应一个出端口
* 路由器
	* 路由器转发平面：输入端口，输出端口，交换结构
	* 转发在端口本地处理：端口存储一份影子转发表，可以纳秒级处理，端口有自己的RAM
	* 查表后转入交换结构，拥挤则排队，转发前可能进行IP端口过滤等检测阻止转发
	* 交换结构
		* 经内存交换：相当于多CPU共享内存，输入输出都从内存读写。一个CPU的每个周期只能读或写一个分组
		* 经总线交换：分组读入时被输入端口打上标签标记接收端口，然后经过总线传输广播到每个输出端口，非目标端口将分组丢弃，目标端口去除标签后转发。总线一次只能通过一个分组，需要所有分组排队进入，速度有限但够用
		* 经互联网络交换：纵横式网格节点，输入端口需要与哪个输出端口连接就只打开与目标端口的节点路径，其余节点路径可以独立连接，达到高并行
	* 输出端口缓存
		* 多个输入端口的分组都去往同一个输出端口时，出口容易堵塞。要保证输出端口有足够的缓存，缓存溢出时，可以弃尾drop-tail。管理丢弃策略的算法叫做主动队列管理Active Queue Management
		* 输入，交换结构，输出根据各自的处理速度都有可能形成瓶颈
		* 线路前部Head of the Line-HOL阻塞：排在输入端口后面的分组必须等交换结构传输完前面有冲突的分组
	* IP协议
		* IPv4格式
			* 32bit：版本|首部长度|服务类型|数据报长度(byte)
			* 32bit：16bit标识|标志|13bit片偏移
			* 寿命|上层协议|首部检验和
			* 32bit源IP地址
			* 32bit目的IP地址
			* 选项
			* 数据
		* 首部长度用来决定是否有可选项，正文数据从哪里开始
		* 服务类型：是否是实时流量等
		* 数据报长度(首部+数据)16bit，所以理论长度为2^16=65535byte
		* 寿命：路由器跳数，每跳减1，确保分组不在网络中永远循环
		* 协议号：绑定网络层和运输层，指示交付报文给TCP，UDP或其他协议，类似于运输层到应用层的端口号
		* 首部检验和：计算首部和的反码，每一跳都要计算并重设，因为TTL等字段会改变。为什么TCP/UDP和IP都要计算检验和：TCP计算全文，而IP计算首部，且IP可以为对接其他运输层协议，TCP也可以对接其他网络层协议，所以只是巧合重复了
		* 选项：导致IP首部长度可变，增加了复杂性和处理时间，在IPv6中去掉
	* IP数据包分片Fragment
		* MTU（Maximum Transmission Unit）：最大传送单元，链路层帧能承载的最大数据量。限制了IP数据包的最大长度
		* IP收到上层的数据大于MTU时，将其分片。同一个源数据报具有相同的标识，最后一片的标志位为0，其他片的标志位为1。偏移字段指示片的顺序，以在接收端重新组装。不在路由器组装是因为减轻路由器负担，减少IP协议复杂程度。
		* 没有成功完整组装的分片将被丢弃；jolt2攻击，一种dos攻击，发送偏移值没有0的片或者不能完整排序的片，路由器可能无法处理而崩溃
	* IP地址
		* 32bit，dotted-decimal notation点分十进制
		* 子网掩码：223.1.1.3/24
		* 分类编址classful addressing a.b.c.d/x 的x只能是8，16，24
			* 8：A类网络
			* 16：B类网络 有2^16 -2= 65534个子网地址可用，太多了浪费
			* 24：C类网络 有2^8-2 = 254个子网地址，太少了，所以采用CIDR灵活分配
		* 因特网地址分配策略-Classless Interdomain Routing--CIDR 无类别域间路由选择
			* a.b.c.d/x： 其中x是网络前缀
			* 前x位相同在一个子网
			* 地址聚合（address aggregation）/路由聚合（route aggregation）/路由摘要（route summarization）：路由转发表中以单个前缀通告多个网络的能力
			* 层次编址：对外接收时200.23.16.0/20
				* --> 200.23.16.0/23
				* --> 200.24.18.0/23
				* --> 200.23.20.0/23
			* 上层ISP向下层ISP分配地址，x逐渐增大，内部可用地址逐渐减小
			* 最上层的ISP：因特网名字和编号分配机构(Internet Corporation for Assigned Names and Numbers--ICANN) 分配IP地址，管理DNS根服务器，分配域名
		* 路由器地址通常由管理员手工分配
		* 主机地址通常由DHCP（Dynamic Host Configuration Protocol）动态主机配置协议
			* 场景：用户经常更换，要节约地址时，同时在线人数比较少时可以从地址池中随机选择地址分配
			* DHCP发现（discover message）：新客户通过UDP向67端口发送，目的地址255.255.255.255广播地址，源地址0.0.0.0
			* DHCP服务器提供（offer message）：server发送回复，目的IP255.255.255.255广播地址（因为offer还没送到手上），推荐IP地址，子网掩码，地址租用期（address lease time）
			* DHCP请求（request message）：新客户选择一个服务器进行回应（可能存在多个DHCP服务器）
			* DHCP ACK：服务器确认请求
		* NAT Network Address Translation
			* 动机：IPv4公有地址不够用，划出一部分来做子网私有地址，不让每一个设备都有公有IP
			* RFC1918规定3类private address: 10/8，172.16/12，192.168/16
			* 路由器将子网IP发出的请求的源IP转换为共享的公有IP，端口转换为一个随机选择的空闲端口，转换记录在NAT转换表中
			* 路由器维护NAT转换表： WAN: 138.76.29.7, 5001----LAN：192.168.3.2，3345
			* 缺点
				* 阻碍了端到端的直接通信
				* 路由器处理到了第四层运输层的端口号
				* 端口号不再只和进程对应，而用来对应主机
				* 妨碍P2P程序，连接反转
		* UPnP Universal plug and play 通用即插即用
			* 映射一个NAT上专用的公共端口到私有IP的端口上，同时使得应用程序知晓该IP和公共端口
	* ICMP 因特网控制报文协议 Internet Control Message Protocol
		* ICMP是IP报文的有效载荷，类似于上层协议
		* ping
			* 发送一个ICMP类型为8，编码为0的回显请求给目的主机
			* 目的主机返回一个ICMP类型为0，编码为0的回显回答
			* ping程序多直接实现在操作系统中，而不作为一个进程提供服务
		* ICMP源抑制报文，可以让主机减缓发送，拥塞控制
		* 实现Traceroute：依次发送TTL为1，2，3...的递增TTL的UDP报文，这些UDP报文具有不可达端口。当沿途路由器发现ICMP包的TTL变为0时，会发给发送方一个警告ICMP报文，包含了路由器的IP和名称。traceroute在发送包时启动计时，就可以知道往返时延了。当最终到达目的主机时，由于UDP端口不可达，目的主机也返回一个警告报文，过程结束。
	* IPv6
		* 格式
			* 32bit：版本|流量类型|流标签
			* 32bit：有效载荷长度|下一个首部|跳限制
			* 128bit：源地址
			* 128bit：目的地址
			* 数据
		* 舍弃了一些选项字段
		* 流标签：标记实时流量或者高优先级的流量
		* 下一个首部：需要交付给那个协议
		* 路由器上的分片操作被删除，放到端系统中实现。如果数据过大，包被丢弃，并返回ICMP差错报文
		* 首部检验和被删除，为了追求快速处理
		* 选项字段被删除，选项可以出现在【下一个首部】的位置。IPv6首部变成40字节的定长
		* IPv4到IPv6的迁移：双栈dual-stack，让路由器两者都支持，尽量使用IPv6
			* 数据迁移方式：将IPv6的数据誊写到IPv4的报文上
			* 隧道方式：将IPv6报文完整的写入IPv4的数据部分，到了隧道另一端的IPv6路由器再取出
		* IP协议的安全版--IPsec协议
			* 密码技术：加密报文
			* 验证数据完整性
			* 检验源IP地址真实性
* 路由选择算法
	* 分类：
		* 全局路由选择算法global routing algorithm：如Link State--LS算法，需要具有全局的状态信息
		* 分散式路由选择算法decentralized routing algorithm：如Distance-Vector--DV距离向量算法。不需要全局信息，只需要邻近节点的信息
		* 静态的或动态的
		* 负载敏感的或负载迟钝的load-insensitive
	* Dijkstra算法；震荡问题的解决--随机时机执行LS算法
	* 距离向量算法：每个路由器维护一个向量表，距离有更新时向自己的邻居转发表，更新距离。直到不再需要更新距离。距离的更新选最小值
		* 无限路由问题：如果费用改变，在没来得及传出消息时已经被旧消息的过时信息覆盖
		* 无限路由的解决：毒性逆转，只要经过要告知的路由器发包，就假称自己没有一条直连目的地的线路（宣称费用是∞）
	* 自治系统Autonomous System
		* 理由：网络规模大时路由算法开销很大；某些机构希望自己控制路由算法
		* 自治系统内部路由选择协议intra-autonomous system routing protocol：AS内部的协议
		* 网关路由器：AS之间负责转发的路由器
		* 自治系统间路由选择协议inter-autonomous system routing protocol：所有AS上都运行同一个协议，BGP4
		* AS间路由过程
			* 若AS只有一个网关路由器作为出口：只需通过AS内协议路由到网关即可
			* 若有多个出口：热土豆选择hot potato routing，选择费用上最近的网关，将表项添加到自己的转发表中。尽快将报文送出本AS
* Internet路由选择
	* 自治系统内/内部网关协议
		* RIP--路由选择信息协议Routing Information Protocol
			* 一种DV协议
			* 最大跳数为15
			* 通过RIP响应报文每30秒左右交换一次，又称RIP通告（advertisement）；180秒没有收到通告，认为邻居不可达
			* 维护路由选择表routing table：目的子网，下一台路由器，到目的地的跳数
			* 路由器之间用UDP协议，520端口来交换RIP请求与响应
		* OSPF--开放最短路优先Open Shortest Path First
			* 洪泛链路状态信息+Dijkstra算法
			* 由网络管理员设置链路费用
			* 周期性（30min）的向AS内所有路由器广播
			* 提供密钥鉴别，防止攻击
			* 支持同时使用多条等费用路径
			* 可在域内构造层次结构
				* 每个子区域有自己的OSPF链路算法
				* 提供区域间路由的路由器称为区域边界路由器area border router
				* AS内仅有一个OSPF区域配置成主干backbone，为AS内区域之间提供路由(普通路由器->区域边界路由器->主干路由->目的区域边界路由器->目的地)
	* 自治系统间路由选择-BGP
		* 边界网关协议Border Gateway Protocol
		* 通过179端口半永久的TCP连接交换路由选择信息
		* AS内每对路由器之间有一条TCP连接，BGP对等方peer
		* internal BGP session：AS内的BGP会话(BGP session)
		* external BGP session：AS间边界路由的BGP会话
		* 可达性信息通过通告聚合的CIDR前缀(e.g. 138.16.64/22)
		* ASN：由ICANN分配全局唯一的自治系统号ASN--Autonomous System Number
		* 一条路由route：BGP会话时通告的一个前缀和一些BGP属性
			* AS-PATH：已经经过的一连串AS的ASN。如果路由器发现自己的ASN在其中，为了防止循环通告，它将拒绝通告
			* NEXT-HOP：下一跳AS的第一台路由器的IP地址
		* 输入策略：路由器知道多条可达路由时，可根据偏好过滤掉一些路由
		* BGP路由选择：设置一系列过滤器，选择滤过后的
			* 最高的本地偏好值
			* 最短的AS-PATH路由（AS间跳数最短）
			* 热土豆选择
			* BDP标识符
		* 可以通过设置BGP路由策略来防止“搭便车”的行为：双方能直连就宣称不能从自己中继
		* AS间的BGP路由是策略主导的，更多是商业因素决定是否穿过一个AS，而不是看性能优劣
	* 广播路由选择
		* N次单播：单个源发出N个副本
			* 优点：简单，不必采用新协议
			* 缺点：链路冗余负载，需要知道所有目的地址
		* 无控制洪泛flooding：每个路由器向它的所有邻居发送副本，将可能形成广播风暴
		* 受控洪泛
			* 序号控制洪泛sequence-number-controlled flooding：检查每个包的地址和序号，如果重复就丢弃包
			* 反向路径转发Reverse Path Forwarding--RPF：只接收通向源的最短路径的接口传来的广播转发，同时将包广播给除了这个接口以外的所有接口
			* 虽然避免了广播风暴，但是仍有冗余包在路径上传播，占用带宽
		* 生成树广播Spanning tree：
			* 特点
				* 没有冗余的传播
				* 费用最小的生成树称为最小生成树minimum spanning tree
				* 节点仅需要向在生成树中的邻居发送分组即可
				* 可以从树中的任意节点出发来发送广播
			* 基于中心的方法
				* 选定一个中心节点，其余节点向中心节点单播加入树(tree-join)报文，遇到已经加入树的节点，路径上的所有节点就都加入生成树
	* 多播multicast
		* 应用：视频会议，应用更新，直播
		* 网络层多播：IGMP+多播路由选择协议
		* IGMP--因特网组管理协议Internet Group Management Protocol
			* 仅在第一跳路由器和主机之间发生交流
			* 采用软状态soft state来维护连接状态：软状态更灵活，不需显式地维护
			* IGMP报文封装在IP数据报中，IP协议号为2
			* 路由器周期性地向主机发送membership_query报文，询问主机是否还要加入一个多播组
			* 主机产生一个membership_report报文回复query报文，如果路由器超时未收到回复，则默认将主机从组中删除
		* 多播路由算法
			* 基于生成树的多播：选择一个路由器作为中心节点，其他连接主机的边缘路由器向中心发送加入报文，如果遇到树的部分就加入树
			* 基于源的RPF多播转发树：除了基本的RPF算法，还要补充剪枝pruning行为。剪枝的理由：如果一个路由链条的末端不存在接收多播的主机，会无端占用这条链条上的资源。最下游的路由器可以向上游发送剪枝报文，以请求不要发送多播分组。如果上游路由器的所有下游路由器都发送剪枝报文，它也可向上游转发剪枝报文。
			* 实际因特网中的多播路由协议
				* DVMRP距离向量多播路由选择协议Distance Vector Multicast Routing Protocol：RPF剪枝算法
				* PIM协议无关的多播Protocol Independent Multicast
					* 稠密模式dense mode：多播组成员分布密集时，采用洪泛和RPF剪枝策略
					* 稀疏模式sparse mode：构造多播树
				* AS内的多播：像RIP，ISIS，OSPF一样配置PIM和DVMRP
				* AS间的多播：采用BGP的扩展，或MSDP多播源发现协议Multicast Source Discovery Protocol



# 链路层
## 提供的服务
* 封装为帧framing
* 协调帧在链路上的传输：MAC媒体访问控制Medium Access Control
* 在链路上的可选择可靠交付（端到端的一部分）
* 差错检测和纠正


链路层的实现位置：网络适配器（network adapter），网络接口卡（Network Interface Card, NIC）和一部分软件实现
## 差错检测和纠正：
* EDC：差错检测和纠正比特Error-Detection and-Correction
* 奇偶校验
	* 奇偶校验位：parity bit
	* 一维奇偶校验
		* 偶校验：在原数据上额外添加一个奇偶校验位 ，设置为0或1，使得值为1的比特的总数是偶数
		* 如果偶校验出错，能知道出现了奇数个比特差错；偶数差错无法检出
		* 实际上比特差错如果发生，错误比特经常多于一个
	* 二维奇偶校验
		* 行校验+列校验
		* 可以通过行列定位出错的比特并纠错单个比特
		* FEC：前向纠错Forward Error Correction。接收方立即检测和纠正差错。对于时延敏感的应用很有意义，如实时视频和星际传输
* 检验和：数据的字节作为16比特整数，加起来取反码作为校验和
* CRC：循环冗余检测Cyclic Redundancy Check
	* 另称多项式编码Polynomial code
	* 异或XOR等价于模2算术
	* d位的数据D，校验码r位的R，r+1位的G（generator，生成多项式）
	* 计算公式： D* 2^r XOR R
	* 被除数：相当于把D左移r位，加上R，总共d+r位
	* G作为除数使得余数为0
	* 出现了差错则余数不为0，且可以看出哪些位出错了
	* G的大小决定了能纠错位数的上限


## 多路访问
* 点对点链路
	* PPP：点对点协议point-to-pint protocol
	* HDLC：高级数据链路控制high-level data link control
* 广播链路
	* 多路访问问题：多个节点对共享信道的访问
		* 碰撞collide：节点同时接收到多个帧
	* 信道划分协议channel partitioning protocol
		* TDM时分复用：在循环的时间帧中为每个节点分配一个时隙slot序号
		* FDM频分复用：划分固定频段给每个节点
		* CDMA码分多址Code Division Multiple Access：给不同节点进行不同的编码，可以同时传输
	* 随机接入协议random access protocol
		* 节点全速发送，在遇到碰撞时稍后重发，每个节点随机选择一个等待时延重发
		* 时隙ALOHA
			* 每个时隙传输一帧
			* 所有节点同步开始时隙
			* 节点有帧要发送时，等待下一个节点开始时传输
			* 在当前时隙结束前检测到碰撞，以概率p在后续时隙重传帧
			* 效率=成功时隙/（成功时隙+碰撞时隙+空闲时隙）
			* 最大效率0.37R
		* CSMA载波侦听多路访问Carrier Sense Multiple Access /CD 碰撞检测 Collision Detection
			* 说之前先听：先对线路上的信号监听
				* 信道传播时延导致两人可能同时说话
			* 没人说话时再说：检测到没有信号时开始发送信号
			* 别人说时不说：检测到碰撞时停止传输，等待随机时间
				* 等待的时间采用二进制指数后退算法决定
				* 二进制指数后退算法：碰撞了n次，在[0,2^n-1]中随机选一个数的常数倍作为延迟时间
			* 效率efficiency：=1/(1+5d[prop]/d[trans]) prop--传播时间 trans--将一个最大帧发送到信道中的时间
	* 轮流协议tacking-turns protocol
		* 中心的：一个主节点依次通知各节点可以发送的时机和数量
		* 去中心的：令牌传递协议（token-passing protocol），节点把令牌发送给下一个节点，直到最后一个节点发送给第一个节点，形成一个循环
* DOCSIS电缆接入网的多协议应用
	* CMTS：电缆调制解调器端接系统Cable Modem Termination System
	* FDM下行信道：CMTS→调制解调器，只有CMTS在传输，不存在多路访问问题
	* TDM上行信道：调制解调器→CMTS，多路访问
		* CMTS在下行传输时携带MAP报文，可以指定将上行的微时隙指定给某个调制解调器
		* 1个TDM帧=请求微时隙+上行数据微时隙
		* 请求微时隙通过随机接入方式传输，有可能碰撞
		* 如果在下一个下行报文没有接到分配请求的响应，调制解调器推测发生了碰撞，通过二进制指数回退重新发送。如果上行流量少，也可能占用请求时隙来进行数据发送，以避免长时间等待

## 交换局域网
* 链路层寻址
* MAC地址
	* 链路层地址：LAN地址/物理地址/MAC地址
	* 主机和路由器上的网络适配器具有链路层地址
	* 交换机不具有链路层地址，透明地交换数据报
	* 长度6字节，2^48个地址，十六进制表示，1A-23-F9-CD-06-9B
	* 广播地址全1：FF-FF-FF-FF-FF-FF
	* MAC地址假定为固定，虽然可以软件修改
	* MAC地址全局唯一，IEEE管理MAC地址空间，生产网卡的公司向其购买前24bit固定的地址空间，自己分配后24位
	* 发送适配器在发送帧时插入MAC地址，交换机可以广播帧，适配器收到帧时检查地址是否与自己匹配
	* 存在的理由：
		* 虽然有了网络层地址，但需要保持各层独立
		* 网络层地址需要保存在链路层RAM中，增加复杂度
		* 如果链路层向上传递帧，网络层还需要处理不是发给自己的帧，这现在可以由链路层屏蔽
* ARP协议
	* 地址解析协议Address Resolution Protocol：为了得到目的地的MAC地址，跨越链路层和网络层的协议
	* ARP只为同一个子网的IP解析MAC地址
	* ARP表：位于主机和路由器上
		* IP地址--MAC地址--TTL（常为20min）
		* ARP分组：发送IP，发送MAC，接收IP，接收MAC
			* 请求分组：请求者的IP，请求者的MAC，响应者的IP，广播地址
			* 响应分组：响应者的IP，响应者的MAC，请求者的IP，请求者的MAC
	* 发送数据包到子网以外
		* 先将MAC地址填写为路由器的MAC地址，以让路由器接收，转交给其网络层
		* 路由器查询转发表转发到另一个接口，并查询自己的ARP表，填写上目的网卡的MAC地址
* 以太网
	* 简介
		* 有限局域网最流行的协议
		* 使用总线拓扑，每一帧传输到所有适配器
		* 集线器hub：物理层设备，作用于比特而不是帧；收到比特后，放大能量强度 ，从所有接口输出；会实现碰撞
		* 以太网早期使用集线器，双绞铜线，星型拓扑
		* 不可靠，无连接的服务，没有确认帧
	* 以太网帧
		* 前同步码|目的地址|源地址|类型|数据|CRC
		* 数据字段：46~1500字节，长了分片，短了填充，网络层使用IP报文的长度字段去除填充部分
		* 类型字段：提交给网络层具体协议的编号，类似网络层的协议字段，运输层的端口号
		* CRC：4字节
		* 前同步码Preamble：8字节，7个10101010+1个10101011。
			* 时钟同步clock synchronizing：用于同步发送适配器的时钟，信号以高压低压交替传输，发送方的时钟可能对比标准的速率（10M,100M,1G）有偏差，需要先校正以正确解读比特
			* 警示：线路不是一直忙碌，而是有gap。前同步类似某种倒计时预告，最后两个比特11预示重要信息的到来
	* 以太网技术标准
		* 缩写：10BASE-T, 1000BASE-LX, 10GBASE-T
		* 10指带宽，BASE指线路只承载以太网流量，T指双绞铜线
		* CSMA/CD共享广播信道，控制节点间距以提高效率
		* 最初用集线器，近来用交换机，可以全双工



## 链路层交换机
* 交换机对路由器和主机透明，主机和路由器不知道交换机的存在
* 交换机具有缓存，在同一接口全双工
* 即插即用plug-and-play，无需干预
* 交换机表switch table
	* MAC地址--交换机接口--表项插入时间
	* 转发与过滤
		* 表中没有帧的MAC地址，交换机广播该帧
		* 表中有MAC地址，但表项的接口是输入接口，交换机丢弃该帧，完成过滤
		* 表中有MAC地址，且接口是其他接口，交换机转发到响应接口，完成转发
	* 自学习self-learning：在有入帧到达时，检查该帧源MAC地址是否存在于转发表中，如果不存在，插入表项，源MAC地址，入接口，到达时间。如果表项存在，更新到达时间。在经过老化时间（aging time）之后，自动删除过期表项
* 交换机的性质
	* 消除碰撞：链路上同时不多于一个帧，最大速率是各接口速率之和
	* 链路隔离：各种不同速率和介质的链路可以同时运行
	* 自动管理：自动切断乱发帧的适配器，自动断开受损线路
* 交换机嗅探
	* 集线器广播每一帧，容易嗅探
	* 交换机只广播表项中没有的帧，难以嗅探特定MAC的帧，只能收到广播帧
	* 交换机毒化switch poisoning：攻击者向交换机发送大量伪造源MAC地址的帧，填满交换机表，使得所有正常的帧变为广播帧从而嗅探到
* 交换机与路由器的比较
	* 交换机在第二层链路层上存储转发分组；路由器在第三层网络层上存储转发分组
	* 交换机
		* 即插即用
		* 效率比路由器较高，只用处理到第二层。
		* 交换机无法防止广播风暴
		* 交换机用生成树防止循环
	* 路由器
		* 非即插即用，需要配置IP
		* 不用生成树，可以按需配置
		* 可以用防火墙阻止广播风暴
		* 发音有争论
	* 几百台以下的小网络选交换机，大网络选路由器

## 虚拟局域网
* 原由：为了在交换机上实现流量隔离和管理设置VLAN
* 方法：将交换机所有接口划分为多个组，每个组构成一个VLAN
* 解决了广播范围的限制和帧的隔离
* 实现：交换机中维护一张端口到VLAN的映射表；交换机软件仅仅在相同VLAN的端口之间交付帧
* VLAN之间的通信：
	* 将每个VLAN的一个端口连接到一台路由器上，由路由器交换分组
	* 将交换机的一个端口同时分配给两个VLAN，并与一台路由相连
	* 路由器可以集成在同一台VLAN交换机上
	* VLAN干线连接--解决多台交换机互联
		* VLAN标签：在链路层首部源地址后加入VLAN标签，到达目的交换机后去除
		* 结构：
			* 标签协议标识符Tag Protocol Identifier--TPID
			* 标签控制信息字段：12bit的VLAN标识符
			* 优先权字段：3bit，类似IP的TOS字段

## 链路层虚拟化
### MPLS
* MPLS--多协议标签交换Multiprotocol Label Switching
* 为了改善IP路由器的转发速度，基于固定长度的标签来转发数据报，不需根据IP匹配；基于虚电路
* 位于第二层链路层和第三层网络层之间	
* 设备：标签交换路由器（label-switched router）MPLS enable的路由器
* MPLS首部
	* 标签：标识虚电路
	* 实验字段：用于实验
	* S：单比特
	* TTL：寿命字段
* MPLS转发表：入标签--出标签--目的地--出接口  （类似于虚电路表）
* 可以进行流量工程：使流量沿着多条路径到达同一目的地，而通过最低费用路由的DV和LS算法等不能实现
* 用于实现VPN（虚拟专用网，Virtual Private Network）

## 数据中心网络
* 刀片blade：一台包括CPU，内存，硬盘的商用主机
* 刀片被堆叠在机架上，顶部有一个TOR（Top of Rack）机顶交换机，每个刀片通过以太网连接到TOR，TOR之间也互联
* 边界路由器border router：数据中心联通外界的路由器
* 负载均衡：作为请求和响应的中继，分散压力，兼NAT
* 多层次的交换机和路由器结构：以支持大量的服务器和高带宽的通信
* 全连接拓扑（fully connected topology）：第一层交换机连接几台TOR，第二层交换机和第一层交换机之间两两互连。
* MDC（模块化数据中心Modular Data Center）：将许多台服务器包装在一个集装箱中，许多集装箱互相用交换机连接。当集装箱整体性能下降时，将之整体替换。

---
# 移动网络和无线网络
## 一些概念
* 基站base station：提供无线接入的数据中继服务：接入点access point，蜂窝塔cell tower
* 基站的切换hand off
* 基于基础设施：一个无线主机是否与基站连接
* 分类
	* 单跳，基于基础设施：WIFI和蜂窝
	* 单跳，无基础设施：没有基站，蓝牙，自组织网络
	* 多跳，基于基础设施：wireless mesh network，无线网状网络
	* 多跳，无基础设施：如车载自组织网络vehicular ad hoc network

## 无线链路的特征
* 无线链路的特点
	* 路径损耗：信号衰减
	* 电磁干扰：802.11b无线LAN和2.4G无线电话同时通信会产生干扰，因为在同一频段。还有环境电磁噪声
	* 多径传播：电磁波被多次反射变得模糊
* 信噪比（Signal-to-Noise Ratio，SNR）：单位分贝dB，SNR = 20 * log(信号振幅/噪声振幅)
	* 给定调制方案，BER比特差错率与SNR成反比
	* 给定SNR，速率越大的调制技术，BER越高
* 隐藏终端问题hidden terminal problem：A和C同时向B传输，AC无法互相检测到，但都在B处互相产生了干扰
* 衰减fading

## CDMA
* CDMA，码分多址，Code Division Multiple Access
* 属于信道划分协议，广泛应用于无线和移动技术
* 码片速率：chipping rate，在某一个频率划分时隙后，每一个时隙再划分微时隙。微时隙的速率称为码片速率
* CDMA编码器的输出 Z(i,m) = d(i)*c(m)
	* d(i):数据的第i个时隙的值，高压还是低压
	* c(m):编码的第m个微时隙的值，高压还是低压
* CDMA解码器的输出 d(i) = 1/M * Σ Z(i,m) * c(m)
* 在收到干扰的情况下，信号叠加。每个解码器收到的Z是一个叠加后的相同的值。但是各个编码经过仔细的选择，可以用同样的方式恢复出属于自己的数据

## WiFi--802.11无线LAN
* 有几个版本
	* 802.11b 2.4-2.4835GHz
	* 802.11a 5.1-5.8GHz
	* 802.11g 2.4-2.485GHz
* 2.4G频段竞争的还有2.4G电话和微波炉
## 体系结构
### 概念
* BSS：基本服务集Basic Service Set，无线设备和AP。AP通常连接或者直接继承到路由器上
* 每个AP的无线接口有一个MAC地址
* SSID：服务集标识Service Set Identifier。作为AP的ID
* 信道：在85MHz的频段内，划分11个部分重叠的信道。1，6，11三个信道相隔较远而没有重叠，因而每个可以独立构成一个AP

### 关联associate：无线设备和AP之间建立虚拟线路
* 被动扫描：
	1. AP周期性地发送信标帧（beacon frame），包括AP的SSID和MAC地址。无线设备扫描11个信道，找出所有可能的AP，有些AP会选择同一个信道发送信标帧（形成WiFi jungle）。
	2. 主机通过信号强度或其他方法选择一个AP，向其发送关联请求帧
	3. AP向设备返回关联响应帧
* 主动扫描：
	1. 无线设备向所有AP广播探测帧；
	2. AP发送探测响应
	3. 设备选择一个AP发送关联请求帧
	4. AP向设备发送关联响应帧
* 关联后主机通过AP向该子网发送DHCP发现报文，请求IP地址，以加入子网
* Authentification：
	* 通过允许无线设备的MAC地址
	* 通过用户名密码：可将认证服务器从单个AP中抽离出来，从而可以为多个AP服务

### 802.11 MAC协议：
* CSMA/CA：带碰撞避免的CSMA（CSMA with collision avoidance）几个无线设备和AP的关联可能使用同一个信道，需要一个多路访问协议来协调通信。
	* 碰撞避免：
		* 不采用碰撞检测：成本较大，且由于隐藏终端问题和衰减问题而无法检测到所有的碰撞
		* 每次会完整发送一个帧，如果发生碰撞，双方的信道都会浪费，因此会尽量避免碰撞
	* 链路层确认重传：link-layer acknowledgment，接收方等待SIFS（短帧间间隔Short Inter-Frame Spacing）后，发送确认帧。发送方超时仍未收到确认帧则重传
	* 帧的发送过程
		1. 监听信道是否空闲，如果是，则在DIFS（分布式帧间间隔Distributed Inter-Frame Space）后发送帧
		2. 若信道忙，随机时间回退，重新侦听；信道空闲则递减值
		3. 递减到0时，发送数据帧并等待确认
		4. 若收到确认，从第二步开始准备下一帧。若没收到确认，选择更大的回退值
	* 隐藏终端问题的处理
		* RTS：短请求发送Request to Send，发送方在发送之前向AP发送RTS帧，预约信道的使用，指示需要的传输时间
		* CTS：允许发送Clear to Send，AP向所有节点广播，向发送方表示确认，同时指示其他节点在预约期内静默
		* RTS和CTS本身还是有可能碰撞，但其本身短小，损失小
		* RTS/CTS会增加时延占用带宽，所以仅在发送的数据帧长度超过某个设定阈值后才启用
* 802.11作为点对点链路：两个节点可以将定向天线指向对方，可以大幅增加通信距离到数十公里

### IEEE 802.11 帧
帧
|2  |2  |6  |6  |6  |2  |6  |2~2312|4  |
|---|---|---|---|---|---|---|------|---|
|帧控制|持续期|地址1|地址2|地址3|序号控制|地址4|有效载荷|CRC|

帧控制字段扩展
|2  |2  |4  |1  |1  |1  |1  |1  |1  |1  |1  |
|---|---|---|---|---|---|---|---|---|---|---|
|协议版本|类型|子类型|到AP|从AP|更多标识|重试|功率管理|更多数据|WEP|Rsvd|

* 包含CRC字段
* 有效载荷承载IP或ARP分组
* 4个地址字段
	* 地址1：目的MAC地址
	* 地址2：发送方MAC地址
	* 地址3：与AP相连的路由器接口的MAC地址，作用是联系BSS和有线局域网
	* 地址4：自组织模式中互相转发
* AP转换以太网帧和802.11帧
	* 路由器不知道AP的存在
	* 路由器发送以太网帧，目的地址是无线主机MAC。AP将地址1填上目的主机MAC，地址2填上自己的MAC，地址3填上路由器MAC，发送802.11帧
	* 无线主机发送802.11帧，将地址1填上AP的MAC，地址2填上自己的MAC，地址3填上路由器MAC，发送802.11帧。AP收到后，转换为以太网帧，源地址为无线主机的MAC，目的地址为路由器的MAC
* 持续期：预约信道的持续期
* 控制字段
	* 类型和子类型：区分 关联，RTS，CTS，ACK，数据帧
	* WEP字段：指示是否使用加密

### 保持的相同IP在子网中移动
两个BSS可能具有相同的SSID，如果两个BSS处于相同的子网，无线设备可以保持原有的IP，无线设备检测到AP1信号逐渐减弱时，收到信号更强的AP2的信标帧，然后设备与AP1解除关联，与AP2建立关联。
交换机如何进行改变来适应设备的BSS切换：可以让设备在建立新的关联后发送以太网广播帧来让交换机进行自学习

### 802.11中的高级特色
* 速率适应：
	* 在连续两个帧没有收到确认时，降低传输速率
	* 在连续10个帧得到确认或者成功传输一段时间之后，提高传输速率
* 功率管理
	* 结点能够在睡眠和唤醒状态之间切换
	* 结点在睡眠之前，设置802.11帧首部的功率管理比特为1，以通知AP，设置一个定时器（闹钟），在下一次AP发送信标帧之前醒来（AP每100ms发送一次信标帧），结点完全醒来只需250us。
	* AP收到结点睡眠的消息后，缓存所有发向它的帧（不吵醒睡觉）。在下次发送信标帧时，列出所有需要收取缓存帧的结点
	* 结点收到信标帧，如果发现有自己的帧，则发送探询报文请求发送缓存的帧。
	* 结点闲时可在99%的时间睡眠

## 蓝牙和ZigBee
### 蓝牙
* IEEE 802.15.1，另称WPAN--无线个人区域网络Wireless Personal Area Network
* 小范围，低功率，低成本；自组织网络；最高4Mbps
* TDM，无需许可证的2.4GHz频段，时隙长625us
* FHSS：跳频扩展频谱Frequency-Hopping Spread Spectrum，每个时隙伪随机变更信道
* 自组织
	* 皮可网piconet：组织一个8个活动设备的piconet
	* 主设备：指定一个主设备，其余为从设备。主设备的时钟控制皮可网的时间，在奇数时隙中发送
	* 从设备只能在主设备在前个时隙与其通信后才可发送，且只能发送给主设备
	* 寄放设备parked：可被转换为活动设备（候补）


### ZigBee
* IEEE 802.15.4
* 低功率，低速率，长周期
* 主从模式

## 蜂窝网
* 带许可证的频段
* 数百kbps
* 1G：语音通信
* 2G: 语音通信
	* BTS：收发基站Base Transceiver Station，向cell内发送接收信号
	* FDM/TDM：先把频带划分为频率子带，再在频率子带上划分帧和时隙
	* MSC移动交换中心：Mobile Switching Center，呼叫建立和切换	
		* BSC基站系统：Base Station System
			* BSC基站控制器：Base Station Controller，服务几十个BTS收发基站，为用户分配无线信道，执行寻呼（paging）
			* BTS
* 2.5G：语音和数据
* 3G：语音和高速数据
	* 核心接入网
		* 和原有的通话网络平行建立，不触动原有的通话网络
		* SGSN：服务通用分组无线服务支持结点Serving Generalized packet radio service Support Node
		* GPRS：通用分组无线服务General Packet Radio Service
		* GCSN：网关GPRS支持结点Gateway GPRS Support Node，连接入因特网的网关
	* 无线边缘接入网
		* 3G无线电接入网（radio access network）无线第一跳网络
			* RNC：无线电网络控制器Radio Network Controller，既通过MSC与电路交换蜂窝语音网连接，又通过SGSN与分组交换的因特网连接
			* DS-WCDMA：直接序列宽带CDMA（Direct Sequence Wideband CDMA）,弃用了2G的FDMA/TDMA方案，同时采用三种信道共享方法
* 4G
	* 标准：LTE，长期演化，4G Long-Term Evolution
	* 全IP网络：语音和数据在IP数据报中承载
	* OFDM：正交频分复用Orthogonal Frequency Division Multiplexing。每个频率上分配多个时隙，而不互相干扰

## 移动管理
* 归属网络-永久地址
* 被访网络-移动结点
### 寻址
* COA：转交地址Care-Of Address，或外部地址
* 外部代理将COA告诉归属代理，外部通过归属代理联系移动结点
### 路由到移动结点
* 移动结点的间接路由选择
	* 移动结点连接到外部网络时，向外部代理注册，离开时取消注册
	* 外部结点向归属代理注册移动结点的COA，当结点再次移动时，新的COA覆盖旧的COA
	* 通信过程：
		1. 通信者向归属代理发送数据报
		2. 归属代理封装原始数据报，然后发送给外部代理
		3. 外部代理从封装中取出原始数据报，然后向移动结点交付原始数据报
		4. 移动结点响应时直接寻址通信者，不通过之前的过程。以自己的永久地址作为源地址，以通信者的IP作为目的IP
* 移动结点的直接路由选择
	* 通信者代理代替归属代理的转发角色（可以由通信者本身担任）
	* 通信过程：
		1. 通信者代理向归属代理询问移动结点的COA
		2. 通信者代理直接向外部代理发送数据报；第一次发送的外部代理称为**锚外部代理**
		3. 外部代理向移动结点转发数据报
		4. 如果移动结点移动到新的网络，移动结点首先向新的外部代理注册，然后新的外部代理向锚外部代理注册新的COA
		5. 通信者代理继续通过锚外部代理的转发与新外部网络中的移动结点通信

## 移动IP
* 代理发现
	* 代理通告agent advertisement：代理周期性广播类型字段为9的ICMP报文，包含代理的IP地址
	* 代理请求agent solicitation：移动结点主动广播一个代理请求报文（类型为10的ICMP）。收到请求的代理将向移动结点单播一个代理通告
* 向归属代理注册：
	* 注册请求：移动代理-->外部代理-->归属代理
	* 注册回答：移动代理<--外部代理<--归属代理

## 蜂窝网中的移动性
* 采用间接路由选择
* 归属网络---被访网络
### 移动用户呼叫的路由选择
* HLR：归属位置注册器Home Location Register，由归属网络维护地一个数据库，储存用户的永久蜂窝电话号码和当前位置
* GMSC：网关移动服务交换中心Gateway Mobile services Switching Center。或归属MSC，用来与呼叫者通信
* VLR：访问者位置注册（Visitor Location Register）：被访网络维护的数据库，记录当前存在的移动用户

1. 由拨打号码的前几位全局地判断归属网络，呼叫通过公共交换电话网到达归属网络
2. 归属MSC收到呼叫后查询HLR，确定移动用户的位置，并返回MSRN（移动站点漫游号码Mobile Station Roaming Number）。漫游号码作为暂时的转交地址。如果HLR查不到漫游号码，则返回VLR的地址。归属MSC然后查询VLR获得漫游号码
3. 通话建立：呼叫者->归属MSC->被访MSC->基站->移动用户

### 基站切换
* 时机选择：信号减弱或拥挤导致的负载均衡
* 做法：
	* 通过锚MSC中继
	* 直接连接
* 对高层的影响：TCP面对丢包的对应方法是减小拥塞窗口，由于无线链路的高比特差错率，TCP一味地降低拥塞窗口是不合理的，对此可以采取：
	* 本地恢复：在差错出现的当时当地将其修复
	* TCP发送方区分无线链路和有限链路
	* 分离全程连接为有线段和无线段，有线段采取正常TCP协议，无线段用特质的其他协议


# 多媒体网络
## 多媒体应用
* 视频
	* 高比特率：2Mbps，音乐图片只有100kbps
	* 可压缩：
		* 空间冗余：每一帧的重复像素
		* 时域冗余：帧之间的相同部分
* 音频
	* 模拟音频转换为数字信号：PCM--脉冲编码调制Pulse Code Modulation
		* 采样：以固定速率采样，每个采样值是任意实数，如8000次/秒
		* 量化quantization：采样值舍入后，变成某个范围内的整数，范围通常是2的幂，如256个
		* 每个采样值由8bit（假设256个量化值）表示，数字信号速率为64000bit/s=64kbps
		* 过程中丢失了原有的质量，如一些高频，提高采样速率和量化值范围可以改善
	* 网上多使用压缩技术传输
		* MP3：MPEG1第3层
		* AAC：苹果常用
* 多媒体网络应用
	* 流式视频
	* IP语音
		* Voice-over-IP--VoIP

## 流式视频
* 采用客户端缓存预取
* UDP流：较少使用，UDP流量容易被NAT和防火墙拦截
* HTTP流：较为流行，TCP发送缓存--TCP接收缓存--TCP应用缓存--视频解压缩并显示。可客户端的缓存占满后会传导反馈到服务器，使之停止发送
* DASH：**经HTTP的动态适应性流** Dynamic Adaptive Streaming over HTTP。视频被编码为不同比特率的版本，客户动态的根据带宽切换
* CDN：内容分发网 Content Distribution Network
	* 不储存全部视频，而采取缓存策略，当视频被请求时再在CDN集群上缓存
	* 请求重定向到CDN：解析域名时，原网站的权威DNS服务器先返回CDN的域名，然后用户向CDN的DNS服务器发起DNS请求，CDN的DNS返回CDN内容服务器的IP地址
	* 集群选择策略：
		* 地理上邻近
		* 测量延迟最小的
		* IP任播（IP anycast）：CDN的不同集群向BGP通告相同的IP地址
		* CDN负载均衡
* 语音IP
	* 时延抖动：接收方收到包的延迟间隔不一定
	* 播放策略：
		* 固定播放时延：发送方打上时间戳，接收方在固定的时间d后播放。如果包错过时间视为丢包
		* 适应性播放时延
	* 丢包恢复
		* FEC：前向纠错 Forward Error Correction
			* 冗余块：每隔n个块之后发送前n个块的冗余。占用带宽较大
			* 部分搭载低质音频流：每个块附加上前一个块的低分辨率音频流，如果前一个块丢失，则用这个低分辨率的音频代替
		* 交织：interleaving
			* 把原来的包分成小块打散重组：123 456 789 -> 147 258 369
			* 增加了时延，没有额外带宽需求，音频质量提高
		* 差错掩盖：丢包小的时候适用，插值法或者复用丢包前的分组
	* 中继：Skype，两个位于NAT后的对等方，通过一个没有NAT的中间方来中继数据。两个对等方分别与中继建立连接
## 实时会话应用协议
### RTP
* Real-time Transport Protocol
* 首部：有效载荷类型，序号，时间戳，同步源标识符，其他字段
	* 时间戳：每个采样周期（如125us）增加1
	* 同步源标识符：随机选择的一个数，作为RTP源的ID
### SIP
* 会话发起协议：Session Initiation Protocol
* 过程：沟通IP地址，音频编码，通信端口
	1. 发起方发送INVITE报文
	2. 接收方响应同意通话报文
	3. 发送方发送ACK
* 像发邮件一样发送呼叫请求
* SIP注册器动态的把SIP地址翻译成IP，像DNS+交换机一样地工作

## 支持多媒体的网络
* 尽力而为的服务
* 区分服务
* 每连接服务质量保证
## 分类提供网络
* 优先流量类型
* 流量隔离：防止低优先级流量被饿死
* 链路调度规则：
	* FIFO
	* 优先级队列
	* 循环排队规则（一个组完成后切下一个组）
	* WFQ（加权公平排队Weighted Fair Queuing）:保证某一类总能得到一个固定比重的带宽
* 监管
	* 目标：平均速率，峰值速率，突发长度
	* 漏桶机制：
		* 给所有分组发放令牌，从上口以速率r产生补充令牌，从下口给分组发放令牌。
		* 桶容量为b，相当于缓存，峰值速率不能超过b
		* 平均速率不能超过r*t+b
		* 采用WFQ调度机制的n路复用的漏桶流
* 区分服务：Diffserv体系
	* 边缘执行分类
	* 每跳行为
* QoS
	* 为了保证带宽够用，需要排斥别的流量。**呼叫准入**证明谁又资格使用带宽
	* 成本过高，应用不广
---
# 网络安全
## 什么是安全
* 机密性confidentiality：报文加密encrypted
* 报文完整性message integrity：检验和
* 端点鉴别end-point authentication：确认通信双方的身份
* 运行安全性operational security：防止用于通信的设备遭到攻击
* 可能遭受的攻击：对报文的窃听以及增删改
	* 邮件
	* 在线金融服务
	* DNS
	* 路由计算

## 密码学原则
* 明文--加密算法--密文--解密算法--明文
### 对称密钥
#### 历史
* 凯撒密码：每个字母用该字母后面的某个字母代替
* 单码代替：每个字母用另一个随机但唯一的字母代替，形成映射
	* 唯密文攻击：ciphertext-only attack，攻击者只有密文
	* 已知明文攻击：known-plaintext attack，知道部分明文和密文的对应关系
	* 选择明文攻击：chosen-plaintext attack，攻击者能让发送者发送指定的内容，从而获得部分明文密文对应关系
* 多码代替密码polyalphabetic encryption：相同字母用不同的编码方式编码
	* 两种编码方式C1，C2
	* 两个凯撒密码密钥C1：k=5，C2：k=19
	* 对明文依次使用C1，C2，C2，C1，C2方式编码
#### 现代
* 流密码（stream ciphers）
* 块密码（block ciphers）：
	* 用途：
		* PGP：安全电子邮件
		* SSL：TCP连接
		* IPsec：网络层IP
	* 历史方法：维护一张大表，开销太大
		1. 划分报文为k比特的块，每块独立加密
		2. 将每块采用某种映射，如011->100 （k=3）
	* 现代方法：
		1. 64bit输入，分割成8个8bit小块
		2. 每个小块独立转换映射成新的小块
		3. 64bit置乱函数，输出打乱后的64bit
		4. 回到第一步，进行n轮循环
		5. 防止相同的明文产生相同的密文，引入随机块。
			* 密文=密钥*（明文 异或 随机码）
			* 传送时：密文块1 随机码1 密文块2 随机码2...
			* CBC：密码块链接 Cipher Block Chaining，为了减少传送的密文块节省带宽，仅发送初始随机码，称为IV（Initialization Vector），后续的随机码用前一个块的密文块代替
### 公开密钥系统
* 公钥加密私钥解密
* RSA算法（Ron Rivest, Adi Shamir, Leonard Adleman）：把要加密的报文看成一个大的数，用来做运算
* 过程：
	1. 选择两个大的素数p和q
	2. 令n=p*q，z=(p-1)(q-1)
	3. 选择一个小于n的数e，且e和z没有公因数。e是加密密钥
	4. 求出一个d，使得 ed mod z = 1，d是解密密钥
	5. 开始加密，明文为m，输出c = m^e mod n
	6. 开始解密，m = c^d mod n
* RSA的工作原理：
	* 要证明的是加密后解密能还原：
		* c^d mod n = m
		* 展开c： (m^e mod n)^d = m
	* 已知模n算数的定理 (a mod n)^b = a^b mod n
	* 则(m^e mod n)^d= m^ed mod n
	* 还已知数论中 m^ed mod n = m^(ed mod z) mod n
	* 已知 ed mod z = 1，代入上式
	* m^ed mod n = m^1 mod n = m
* 应用：RSA的指数运算耗费很多时间，也因此难以破解。而DES（Data Encryption Standard，一种对称加密方法）比RSA运算快得多，快100~10000倍，因此RSA常用来加密传输DES的会话密钥，之后都用DES来加密对话。

## 报文完整性和数字签名
### 密码散列函数
将报文生成固定长度的摘要
* MD5
* SHA-1:Security Hash Algorithm，美国政府标准，散列成160bit摘要

### 报文鉴别码MAC
* 鉴别密钥：authentication key
* 报文鉴别码：MAC--Message Authentication Code
* 双方共享一个鉴别密钥，与报文结合后，算出摘要，连同摘要一起发送。接收方按同样过程验证，可以防止报文和摘要同时遭到篡改
* 确保报文完整，避免了加密解密过程
* HMAC是流行的标准
* 分发密钥，可通过公钥加密鉴别密钥，向所有路由器分发

### 数字签名
* 私钥只有拥有者持有，用私钥加密报文，生成签名，随同明文发送。然后收信者可以用众所周知的公钥解密签名，与明文对照
* 私钥加密报文全文过于耗时，将报文先用散列函数生成摘要，然后再用私钥加密摘要生成签名，更为高效
* 公钥认证：public key certification，证明某个公钥属于谁
	* CA：Certification Authority，认证中心，认证某个公钥属于某人
	* CA用自己的私钥加密自己管理的公钥生成证书certificate，然后别人用CA的公钥来提取证书中的公钥

## 端点鉴别
* end-point authentification
* ap: authentification protocol
### ap1.0
* A直接向B宣称自己是A
* 攻击者也可以这样宣称
### ap2.0
* A有周知的ip地址，B检查数据报ip地址是否是A的
* 攻击者可以改造操作系统，伪造ip地址
	- 第一跳路由器可以配置为拒绝数据报ip和发送者ip不匹配的情况
		- 攻击者也可以配置第一跳路由器
### ap3.0
* 使用口令密码
* 攻击者可以窃听密码的传输
### ap3.1
* 使用对称密钥加密后的口令；可以证明发送者同时拥有密码和加密密钥
* 回放攻击playback attack：攻击者可以截取然后再次发送加密后的报文
### ap4.0
* 不重数（nonce）：只使用一次的数，类似于TCP握手中时间戳的作用
* 服务器在收到A的请求后，发送一个不重数，A用对称密钥加密不重数和报文。B收到后解密，对照不重数是否只使用了一次。避免重放攻击

## 安全电子邮件
### 概述
* 机密性：
	1. 对称密钥加密报文
	2. RSA公钥加密对称密钥
	3. 将加密后的报文和密钥打包发送
* 发送方鉴别
* 报文完整性
	1. 生成明文散列
	2. 对散列用自己的私钥加密生成自己的签名
	3. 明文加上自己的签名打包
	4. 打好的包用接收方的公钥加密
### PGP
* Pretty Good Privacy：电子邮件加密方案
* 综合运用签名，散列
* 允许用户自己认证公钥

## SSL
* 安全套接字层 Secure Socket Layer
* 安全加强TCP连接
* TLS：Transport Layer Security，SSL版本3的修改版
* 应用：HTTPS，网购
* 从结构上说，TCP套接字上是应用层的SSL子层，SSL封装一个SSL套接字给应用程序。但是从应用程序的视角看，SSL套接字相当于传输层TCP

### 宏观描述
1. 握手
	1. TCP连接
		* C->TCP SYN
		* S->TCP SYNACK
		* C->TCP ACK
	2. SSL握手
		* C->SSL hello
		* S->证书
		* C->EMS加密主密钥（客户提取服务器的公钥，用来加密本次会话的主密钥MS）
2. 密钥导出：双方各自用主密钥生成四个密钥
	* E(B)：B到A的会话加密密钥
	* M(B)：B到A的会话MAC密钥
	* E(A)：A到B的会话加密密钥
	* M(A)：A到B的会话MAC密钥
3. 数据传输
	* 为了及时验证完整性，将会话流分块为**记录**，记录+MAC打包，打的包进行散列
	* 在MAC加上序号，以防止中间人攻击

* 连接关闭：结束会话可以通过停止TCP连接，发送TCP FIN。但这样会遭遇截断攻击（truncation attack），攻击者会发送TCP FIN从而强行中断对话。

## IPsec与VPN
* 提供网络层安全性
* 专用网络需要独立的路由器，链路等基础设施，过于昂贵
* 网关路由器将IPv4数据报，转化为IPsec数据报。结构为IPv4首部+IPsec首部+IPsec加密载荷
* IPsec协议族的两个主要协议
	* AH协议：鉴别首部 Authentication Header
	* ESP协议：封装安全性载荷 Encapsulation Security Payload
* 安全关联：Security Association，源到目的的单向连接。发起方维护状态信息如SA的ID称为安全参数索引SPI，接口，加密类型和密钥等

### IPsec数据报
* 运输模式：transport mode
* 隧道模式：tunnel mode
	* 结构：
		1. 初始IPv4数据报后添加ESP尾部字段
		2. 用算法和密钥加密上一步结果
		3. 在头部添加上ESP首部字段，得到enchilada
		4. 生成enchilada的鉴别MAC
		5. 将MAC附加到enchilada后得到载荷
		6. 附加一个普通IPv4首部到载荷前面
	* 特点：载荷内容完全加密，保证完整性，源鉴别，重放攻击保护
	* IKE：因特网密钥交换 Internet Key Exchange。在IPsec会话中传递密钥

## 无线LAN安全
### WEP
* WEP：（Wired Equivalent Privacy）有线等效保密
* AP鉴别无线主机
	1. 无线主机请求AP鉴别
	2. AP响应一个不重数
	3. 主机用与AP的共享密钥加密不重数，发送给AP
	4. AP解密该不重数
* 过程很复杂，见原文Page479
* WEP提供相对弱的加密
### 802.11i
* 专用鉴别服务器
* EAP
* PMK
* TK

## 防火墙，IDS，IPS
### 防火墙
* 软件与硬件的结合
* 位于外部网络与内部网络的边界
### 传统分组过滤器
* traditional packet filter
* 通过维护访问控制表
* 允许--源地址--目的地址--协议--源端口--目的端口--标志比特
### 状态分组过滤器
* 跟踪每个TCP连接的状态，检查每个分组属于一个正常的连接
### 应用程序网关
* 常见的有邮件服务器，web高速缓存
* 针对特定应用程序的监管
* 作为一个服务器，有自己独立的进程
* 防火墙禁止所有目标应用流量，仅允许通过应用程序网关发出的流量，从而迫使所有应用流量通过该网关
* 通过网关中继代理内部与外部的通信
	* 客户通过SSL发送http请求到代理
	* 代理解密请求发送明文http到目标服务器
	* 代理收到响应后通过SSL转发响应
	* 可以隐藏客户的IP，通信的目标和通信内容
	* TOR：加强版，三个串联代理构成代理链

### 入侵检测系统
* IDS，Intrusion Detection System
* 深度检测分组内容，阻止或预警
* 基于特征的：
	* 维护特征数据库
	* 流行应用`Snort`
* 基于异常的：观察数据流的动向，发现不对劲则告警，算法困难

# 网络管理
* 对象标识树
* SNMP
* 表示服务，ASN.1